# manage-gateway-ha
# Удалённое управление умным домом, не имеющего доступа из сети интернет, через Telegram бот

## Назначение

Данное приложение позволяет удалённо управлять устройствами умного дома, организованными на базе Home Assistant (HA),
через Telegram бота.
Телеграм бот используется в качестве шлюза, через который можно выполнять команды на HA.

## Установка приложения

Убедится, что на сервере установлен Python (рекомендуется версия 3.12)

Через консоль  зайти в директорию установки приложения.
Выполнить команду git@github.com:ddvNporit/manage-gateway-ha.git

Настроить виртуальное окружение:

  virtualenv .venv

  source .venv/bin/activate

  pip install -r requirements.txt


## Запуск приложения

Перед использованием необходимо добавить в корень проекта файл конфигурации `.env` по шаблону:

BOT_TOKEN=<ТОКЕН_ТЕЛЕГРАМ_БОТА>

BOT_ALLOW_USERS=<СПИСОК_ID_ПОЛЬЗОВАТЕЛЕЙ_ТЕЛЕГРАМ_С_ДОСТУПОМ_К_БОТУ>

HA_TOKEN=<ТОКЕН_ДОСТУПА_К_HA_ПО_API>

HA_URL=<ВЕБ_АДРЕС_HA>

ALIASES=[<псевдоним команды 1>, <псевдоним команды 2> ...]

Приложение запускается через консоль. Команда: python bot.py



## Команды управления

Команды отправляются телеграм боту от пользователей, указанных в конфиге приложения.

- `Hi, Bot`  

  Получить полное имя и ID пользователя Telegram. Команда доступна для незарегистрированных пользователей.

- `HELP`
  Вывод всех доступных команд

### Команды для зарегистрированных пользователей


- `config HA`  

  Перезагрузить Home Assistant.

- `restart HA`  

  Получить конфигурацию Home Assistant.

- `states HA [фильтр]`  

  Получить список всех статусов объектов HA.  
  Опциональный фильтр:  
  - число — вывести первые n элементов,  
  - текст — отфильтровать список по вхождению текста в поле `"entity_id"`.  
  Например:  
  `states HA 2` — первые два элемента,  
  `states HA test` — элементы с "test" в `entity_id`.


- `update:bool states <entity_id> <X>`  

  Обновить статус элемента с указанным `entity_id`.  
  Значение `<X>`:  
  - для статуса выключен — любое из `[0, off, выкл]`,  
  - для статуса включен — любое из `[1, on, вкл]`.  
  Пример:  
  `update:bool states input_boolean.test_switch выкл` — присвоить статус off для  объекта с
   `entity_id` = `input_boolean.test_switch`.

  
   >Получить `entity_id`  можно с помощью команды `states HA`


- `turn HA <entity_id> <X>`  

  Включить объект с указанным `entity_id`.  
  Значение `<X>`:  
  - для выключения — любое из `[0, off, выкл]`,  
  - для включения — любое из `[1, on, вкл]`.  
  Пример:  
  `turn HA input_boolean.test_switch 1` — включить устройство с `entity_id` = `input_boolean.test_switch`.
  >Получить `entity_id`  можно с помощью команды `states HA`


- `ALIAS`
  Вывод всех доступных псевдонимов команд



## Использование псевдонимов команд
  Для команды  `turn HA <entity_id> <X>` допустимо использование псевдонимов.
  Чтобы присвоить псевдоним команды, необходимо в файле конфигурации (.env) заполнить список ALIASES.
  
### Формат  списка псевдонимов:
  
  [{"<ваш имя  псевдонима>": "<команда для бота>"}, ...]
  Например, [{"включи телевизор": "turn HA input_boolean.tele on"}]
  Если боту передать команду "включи телевизор", то он отправит на HA команду turn HA input_boolean.tele on
  
  Для неизвестных команд, бот будет возвращать ответ "Команда не известна".